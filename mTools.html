<!DOCTYPE html>
<html>
<head>
	<title>mTools</title>
	<meta charset="utf-8">
	<script type="text/javascript">
		
		"use strict";
		(function(window){

			var f = {};

			if (!Array.prototype.forEach) {
			    Array.prototype.forEach = function (fn, thisObj) {
			        var scope = thisObj || window;
			        for (var i = 0, j = this.length; i < j; ++i) {
			            fn.call(scope, this[i], i, this);
			        }
			    };
			}
			if (!Array.prototype.filter) {
			    Array.prototype.filter = function (fn, thisObj) {
			        var scope = thisObj || window;
			        var a = [];
			        for (var i = 0, j = this.length; i < j; ++i) {
			            if (!fn.call(scope, this[i], i, this)) {
			                continue;
			            }
			            a.push(this[i]);
			        }
			        return a;
			    };
			}

			/**
				@name 观察者模式
				@example
			*/
			f.observer = {};
			(function(o){
				var _collection = {};
				o.regist = function(action,func){
					if(!action)
						throw new Error( "please confirm the action" );
					if(!_collection[action])
						_collection[action] = [];
					_collection[action].push(func);
				}
				o.unregist = function(action,func){
					if(action){
						_collection[action] = _collection[action].filter(function(obj){
							if(obj === func)
								return false;
							return true;
						});
						return;
					}
					for(var field in _collection){
						var arr = _collection[field];
						_collection[field] = arr.filter(function(obj){
							if(obj === func)
								return false;
							return true;
						});
					}
				}
				o.broadcast = function(action,params){
					if(action){
						if(_collection[action]){
							_collection[action].forEach(function(obj){
								obj.call(this , params);
							});
						}
						return;
					}
					for(var field in _collection){
						_collection[field].forEach(function(obj){
							obj.call(this , params);
						});
					}
				}
				o.clear = function(action){
					if(!action)
						_collection = {};
					else
						_collection[action] = [];
				}
				o.getObserveFunc = function(obj){
					for(var field in this){
						obj[field] = this[field];
						obj._collection = [];
					}
				}
			})(f.observer);

			/**
				@name 单例设计模式
				@example
				var createMask = singleton( function(color){
					console.log("I create a task which color is " + color);
					return document.body.appendChild( document.createElement('div') );
			 	});
			 	var color = "red";
				var mask = createMask(color);
				console.log("mask = " + mask);
			*/
			f.singleton = function(fn){
				var result;
			    return function(){
			        return result || ( result = fn .apply( this, arguments ) );
			    }
			};

			/**
				@name 工厂设计模式
				@example
				factory.add('div',function(){
					//
				});
				factory.add('table',function(){
					//
				});
			 	var oDiv = factory.getInstance('div');
			*/
			f.factory = {};
			(function(o){
				var _collection = {};
				o.add = function(name,fn){
					if(!name)
						throw new Error( 'please call it in right way' );
					_collection[name] = fn;
					return fn;
				}
				o.clear = function(name){
					if(!name)
						throw new Error( 'please call it in right way' );
					_collection[name] = null;
				}
				o.getInstance = function(name){
					if(!name)
						return null;
					if(!_collection[name])
						return null;
					return new _collection[name]();
				}
				o.getFactoryFunc = function(obj){
					for(var field in this){
						obj[field] = this[field];
						obj._collection = [];
					}
				}
			})(f.factory);

			/**
				@name 策略模式,表单验证工具
				@example
				var ret = mTools.validate("This is mTools",{
					isNotEmpty : true,
					maxLength : 20
				});
				console.log('status = ' + ret.status);
				console.log('message_array_length = ' + ret.message.length);

				@example 如果想添加验证规则
				mTools.validator.regist('minLength',[defaultConfig],function(config,str){
					if(!config)
						config = this.defaultConfig;
					//
					return {
						'status':true,
						'message':''
					}
				});
			*/
			f.validator = {};
			f.validate = (function(v){
				var _rule_collection = {},_rules_stack = [];
				var Rule = function(name,defaultConfig,fn){
					this.name = name;
					this.defaultConfig = defaultConfig;
					this.fn = fn;
				};
				// regist default rules
				(function(c){
					// isNotEmpty
					var isNotEmpty = new Rule("isNotEmpty",true,function(config,str){
						if(!config)
							config = this.defaultConfig;
						var ret = {'status':true,'message':''};
						if(config){
							// "" 和 "   " 和 undefined 和 null 都是empty
							if(!(str && str.trim())){
								ret.status = false;
								ret.message = "字段为空";
							}
						}else{
							// 期望为空
							if(str && str.trim()){
								ret.status = false;
								ret.message = "字段不为空";
							}
						}
						return ret;
					});
					_rule_collection["isNotEmpty"] = isNotEmpty;
					//maxLength
					var maxLength = new Rule("maxLength",10,function(config,str){
						if(!config)
							config = this.defaultConfig;
						var ret = {'status':true,'message':''};
						// 先验证str是否为空
						if(!str){
							ret.status = false;
							ret.message = '该字段为空,无法判断长度';
						}
						if(!(typeof str == 'string')){
							ret.status = false;
							ret.message = '该字段不是字符串,无法判断长度';
						}
						if(str.length > config){
							ret.status = false;
							ret.message = '字段长度超过规定最大值' + config;
						}
						return ret;
					});
					_rule_collection["maxLength"] = maxLength;

				})(_rule_collection);
				// add your own validate rules
				v.regist = function(name,defaultConfig,fn){
					if(!name)
						return;
					var _user_rule;
					if(typeof defaultConfig == 'function')
						_user_rule = new Rule(name,null,defaultConfig);
					else
						_user_rule = new Rule(name,defaultConfig,fn);
					_rule_collection[name] = _user_rule;
				}

				return function(obj,rule){
					if(!rule)
							throw new Error( 'The rule could not be null.' );
					var retSet = {'status':true,'message':[]};
					if(typeof obj == 'string'){
						for(var i in rule){
							_rules_stack.push({
								'name' : i,
								'config' : rule[i]
							});
						}
						if(_rules_stack.length > 0)
							for(var index in _rules_stack){
								var name = _rules_stack[index].name;
								var config = _rules_stack[index].config;
								if(!_rule_collection[name])
									continue;
								var ret = _rule_collection[name].fn.call(_rule_collection[name],config,obj);
								if(!ret.status){
									retSet.status = false;
									retSet.message.push(ret.message);
								}
							}
						_rules_stack = [];
						return retSet;
					}
					if(typeof obj == 'object'){

					}
				}
			})(f.validator);
			
			window.mTools = f;

		})(window);

	</script>
	<script type="text/javascript">
		function fn1(){
			function f1(params){
				alert("first finish" + " " + params);
			}
			mTools.observer.regist('finish',f1);
			mTools.observer.regist('finish',function(params){
				alert("second finish" + " " + params)
			});
			mTools.observer.broadcast('finish',"123");
			mTools.observer.unregist('finish',f1);
			mTools.observer.broadcast('finish',"456");
			var obj = {};
			mTools.observer.getObserveFunc(obj);
		}

		function fn2(){
			var createMask = mTools.singleton( function(color){
				console.log("I create a task which color is " + color);
				return document.body.appendChild( document.createElement('div') );
			 });
			var color = "red";
			var mask1 = createMask(color);
			var mask2 = createMask(color);
			alert(mask1 === mask2);
		}

		function fn3(){
			mTools.factory.add('man',function(){
				this.name = "man";
				this.age = 21;
			});
			mTools.factory.add('woman',function(){
				this.name = "woman";
				this.age = 18;
			});
			var woman = mTools.factory.getInstance('woman');
			alert(woman);
			alert("woman.name = " + woman.name);
		}

		function fn4(){
			var str = "  123";
			var ret = mTools.validate(str,{
				isNotEmpty : true,
				maxLength:12
			})
			alert('ret.status = ' + ret.status);
			mTools.validator.regist('minLength',function(config,str){
				if(!config)
					config = this.defaultConfig;
				if(str.length < config)
					return {
						status : false,
						message : '字段长度小于规定最小值'
					};
				return {
					status : true
				}
			});
			var ret1 = mTools.validate("123",{
				minLength : 4
			});
			alert('ret1.status = ' + ret1.status);
		}
	</script>
</head>
<body>
	<button id="b1" onclick="fn1();">click me 1 观察者模式</button>
	<button id="b2" onclick="fn2();">click me 2 单例模式</button>
	<button id="b2" onclick="fn3();">click me 3 工厂模式</button>
	<button id="b2" onclick="fn4();">click me 4 策咯模式,表单验证工具</button>
</body>
</html>